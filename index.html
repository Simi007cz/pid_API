<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PID Departure Boards — Fetcher</title>
    <style>
        :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.4}
        body{margin:20px;color:#0b1220}
        header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        label{font-size:14px}
        input,select,textarea,button{font:inherit;padding:8px;border:1px solid #d0d7df;border-radius:6px}
        .row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
        .small{font-size:13px;color:#4b5563}
        .output{margin-top:18px}
        pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;max-height:50vh;}
        table{border-collapse:collapse;width:100%;margin-top:10px}
        th,td{border:1px solid #e6eef8;padding:6px;text-align:left}
        .hint{font-size:13px;color:#6b7280}
        .controls{display:flex;gap:8px;flex-wrap:wrap}
    </style>
</head>
<body>
    <header>
        <h1 style="margin:0;font-size:18px">PID Departure Boards — Simple UI</h1>
        <div class="small">Requests to https://api.golemio.cz/v2/pid/departureboards</div>
    </header>

    <form id="form" autocomplete="off" onsubmit="return false;">
        <div class="row">
            <label>
                Request mode:
                <select id="mode">
                    <option value="point">by pointId</option>
                    <option value="coords">by lat / lon</option>
                    <option value="custom">custom query string</option>
                </select>
            </label>

            <label id="label-point">
                pointId
                <input id="pointId" placeholder="e.g. 877452 (stop internal id)" />
            </label>

            <label id="label-coords" style="display:none">
                lat
                <input id="lat" placeholder="50.087, use dot" />
            </label>

            <label id="label-lon" style="display:none">
                lon
                <input id="lon" placeholder="14.421" />
            </label>

            <label id="label-radius" style="display:none">
                radius (m)
                <input id="radius" placeholder="250" />
            </label>

            <label id="label-custom" style="display:none">
                query string
                <input id="custom" placeholder="lines=2,3&timeWindow=60" />
            </label>
        </div>

        <div class="row">
            <label>
                optional X-Api-Key
                <input id="apiKey" placeholder="Paste API key here (optional)" />
            </label>

            <label>
                maxResults
                <input id="maxResults" placeholder="50" />
            </label>

            <label>
                timeWindow (min)
                <input id="timeWindow" placeholder="60" />
            </label>
        </div>

        <div class="row controls">
            <button id="fetchBtn" type="button">Fetch departureBoards</button>
            <button id="prettyBtn" type="button">Show pretty table (if available)</button>
            <button id="clearBtn" type="button">Clear</button>
            <div class="hint">The UI builds a GET to /v2/pid/departureboards?...</div>
        </div>
    </form>

    <section class="output">
        <div id="meta" class="small"></div>
        <pre id="raw" aria-live="polite">{ /* response will appear here */ }</pre>
        <div id="tableContainer"></div>
    </section>

    <script>
        // GitHub Copilot
        const mode = document.getElementById('mode');
        const labelPoint = document.getElementById('label-point');
        const labelCoords = document.getElementById('label-coords');
        const labelLon = document.getElementById('label-lon');
        const labelRadius = document.getElementById('label-radius');
        const labelCustom = document.getElementById('label-custom');

        function refreshModeUI() {
            const m = mode.value;
            labelPoint.style.display = m === 'point' ? '' : 'none';
            labelCoords.style.display = m === 'coords' ? '' : 'none';
            labelLon.style.display = m === 'coords' ? '' : 'none';
            labelRadius.style.display = m === 'coords' ? '' : 'none';
            labelCustom.style.display = m === 'custom' ? '' : 'none';
        }
        mode.addEventListener('change', refreshModeUI);
        refreshModeUI();

        const fetchBtn = document.getElementById('fetchBtn');
        const prettyBtn = document.getElementById('prettyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const raw = document.getElementById('raw');
        const meta = document.getElementById('meta');
        const tableContainer = document.getElementById('tableContainer');

        function buildQuery() {
            const params = new URLSearchParams();
            const m = mode.value;
            if (m === 'point') {
                const pid = document.getElementById('pointId').value.trim();
                if (pid) params.set('pointId', pid);
            } else if (m === 'coords') {
                const lat = document.getElementById('lat').value.trim();
                const lon = document.getElementById('lon').value.trim();
                const radius = document.getElementById('radius').value.trim();
                if (lat && lon) { params.set('lat', lat); params.set('lon', lon); }
                if (radius) params.set('radius', radius);
            } else {
                const custom = document.getElementById('custom').value.trim();
                if (custom) {
                    // allow either "a=1&b=2" or "a=1, b=2"
                    custom.split('&').join('&').split(',').map(s=>s.trim()).forEach(part=>{
                        if(!part) return;
                        const [k,v] = part.split('=').map(s=>s && s.trim());
                        if(k) params.set(k, v ?? '');
                    });
                }
            }

            const maxResults = document.getElementById('maxResults').value.trim();
            const timeWindow = document.getElementById('timeWindow').value.trim();
            if (maxResults) params.set('maxResults', maxResults);
            if (timeWindow) params.set('timeWindow', timeWindow);
            return params.toString();
        }

        async function doFetch() {
            raw.textContent = '{ /* fetching... */ }';
            tableContainer.innerHTML = '';
            meta.textContent = '';
            const qs = buildQuery();
            const url = 'https://api.golemio.cz/v2/pid/departureboards' + (qs ? ('?' + qs) : '');
            const headers = {};
            const key = document.getElementById('apiKey').value.trim();
            if (key) headers['X-Api-Key'] = key;

            const start = performance.now();
            try {
                const resp = await fetch(url, { headers });
                const ms = Math.round(performance.now() - start);
                meta.textContent = `GET ${url} — status ${resp.status} ${resp.statusText} — ${ms} ms`;
                const text = await resp.text();
                try {
                    const json = JSON.parse(text);
                    raw.textContent = JSON.stringify(json, null, 2);
                    // try to display a simple table if response looks like departureBoards
                    if (json && (json.departureBoards || json.departureboards || json.departureBoardsResponse)) {
                        renderPretty(json);
                    }
                } catch (err) {
                    raw.textContent = text;
                }
            } catch (err) {
                meta.textContent = 'Network error';
                raw.textContent = String(err);
            }
        }

        function renderPretty(json) {
            // try common shapes: departureBoards: [{stopPoint, departures: [...]}, ...]
            const boards = json.departureBoards || json.departureboards || json.departureBoardsResponse || json;
            // normalize to array
            const arr = Array.isArray(boards) ? boards : (boards && boards.departureBoards ? boards.departureBoards : (Array.isArray(boards.departures) ? [boards] : null));
            if (!arr) return;
            const rows = [];
            arr.forEach(board => {
                const stopName = board.stopPoint?.name || board.stop?.name || board.stopName || board.stopPointName || (board.id || '');
                const departures = board.departures || board.departure || board.departureBoard?.departures || [];
                if (Array.isArray(departures)) {
                    departures.forEach(d=>{
                        rows.push({
                            stop: stopName,
                            line: d.line || d.serviceJourneys?.lineNumber || d.tripShortName || d.route || '',
                            direction: d.destination || d.direction || d.headsign || '',
                            planned: d.plannedWhen || d.plannedDepartureTime || d.planned || '',
                            realtime: d.expectedWhen || d.realtimeDeparture || d.expectedDepartureTime || ''
                        });
                    });
                }
            });

            if (!rows.length) return;

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Stop</th><th>Line</th><th>Direction</th><th>Planned</th><th>Realtime</th></tr>';
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            rows.forEach(r=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(r.stop)}</td><td>${escapeHtml(r.line)}</td><td>${escapeHtml(r.direction)}</td><td>${escapeHtml(r.planned)}</td><td>${escapeHtml(r.realtime)}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            tableContainer.innerHTML = '<h3>Parsed departures</h3>';
            tableContainer.appendChild(table);
        }

        function escapeHtml(s='') {
            return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        fetchBtn.addEventListener('click', doFetch);
        prettyBtn.addEventListener('click', () => {
            try {
                const json = JSON.parse(raw.textContent);
                renderPretty(json);
            } catch {
                alert('No JSON to parse (fetch first).');
            }
        });
        clearBtn.addEventListener('click', () => {
            raw.textContent = '{ /* response will appear here */ }';
            meta.textContent = '';
            tableContainer.innerHTML = '';
        });

        // quick tips
        // Example query parameters you can try in the UI:
        // pointId=877452
        // lat=50.087; lon=14.421; radius=250
        // additional params: lines=2,3&timeWindow=60&maxResults=20
    </script>
</body>
</html>